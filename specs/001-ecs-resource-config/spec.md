# 機能仕様書: 環境別ECSリソース設定

**機能ブランチ**: `001-ecs-resource-config`
**作成日**: 2026-01-18
**ステータス**: ドラフト
**入力**: ユーザー説明: "現在、ecsのメモリや、cpuを全ての環境で統一しているが、それぞれの環境に合わせたスペックに変更できるようにconfigに抜き出すようにする"

## ユーザーシナリオとテスト _(必須)_

### ユーザーストーリー1 - メインアプリケーションの環境別CPU/メモリ設定 (優先度: P1)

インフラ運用者は、環境要件（開発環境と本番環境のワークロード）に基づいて、メインDecidimアプリケーションタスクに異なるCPUとメモリ仕様を設定する必要がある。

**この優先度の理由**: これが本機能の中核的価値である。開発/ステージング環境でのコスト最適化を可能にし、同時に本番環境に十分なリソースを確保する。これがないと、全環境でリソースを浪費するか、本番環境が不十分な容量で苦しむことになる。

**独立したテスト**: dev.jsonとprd-v0292.jsonの設定ファイルに異なるCPU/メモリ値を設定し、各環境にデプロイし、AWSコンソールまたはCLIでECSタスク定義が正しいリソース割り当てを示すことを確認することで、完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** 設定ファイル（例: dev.json）でecs.mainApp.cpuが1024、ecs.mainApp.memoryが2048に設定されている、**操作** スタックをデプロイする、**期待結果** メインDecidimタスク定義がCPU 1024、メモリ2048で作成される
2. **前提条件** 設定ファイル（例: prd-v0292.json）でecs.mainApp.cpuが4096、ecs.mainApp.memoryが8192に設定されている、**操作** スタックをデプロイする、**期待結果** メインDecidimタスク定義がCPU 4096、メモリ8192で作成される
3. **前提条件** 設定ファイルでCPU/メモリ設定が指定されていない、**操作** スタックをデプロイする、**期待結果** システムがデフォルト値（CPU: 2048、メモリ: 4096）を使用して正常にデプロイされる

---

### ユーザーストーリー2 - Sidekiqワーカーの環境別CPU/メモリ設定 (優先度: P2)

インフラ運用者は、環境のジョブ処理要件に基づいて、Sidekiqバックグラウンドワーカータスクに異なるCPUとメモリ仕様を設定する必要がある。

**この優先度の理由**: バックグラウンドジョブ処理のニーズは環境によって大きく異なる。本番環境ではメール一括送信やデータ処理のためにより多くの容量が必要だが、開発環境では最小限のリソースで十分。これによりワーカー層の独立したチューニングが可能になる。

**独立したテスト**: staging.jsonに異なるSidekiq CPU/メモリ値を設定し、デプロイし、メインアプリケーション設定とは独立してSidekiqタスク定義が正しいリソース割り当てを示すことを確認することで、完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** 設定ファイルでecs.sidekiq.cpuが512、ecs.sidekiq.memoryが1024に設定されている、**操作** スタックをデプロイする、**期待結果** Sidekiqタスク定義がCPU 512、メモリ1024で作成される
2. **前提条件** 設定ファイルでecs.sidekiq.cpuが2048、ecs.sidekiq.memoryが4096に設定されている、**操作** スタックをデプロイする、**期待結果** Sidekiqタスク定義がCPU 2048、メモリ4096で作成される
3. **前提条件** 設定ファイルでSidekiqのCPU/メモリ設定が指定されていない、**操作** スタックをデプロイする、**期待結果** システムがデフォルト値（CPU: 512、メモリ: 2048）を使用して正常にデプロイされる

---

### ユーザーストーリー3 - スケジュールタスクの環境別リソース設定 (優先度: P3)

インフラ運用者は、スケジュールされたメンテナンスタスク（メトリクス計算、データクリーンアップなど）が実行中のアプリケーションに影響を与えずに環境に適したリソースを使用する必要がある。

**この優先度の理由**: スケジュールタスクは現在メインタスク定義のリソースを使用している。本番環境では大規模データセット用により多くのリソースが必要だが、開発環境では最小限で済む。これは低優先度だが（タスクはメインアプリのリソースでも機能する）、個別設定により最適化が可能になる。

**独立したテスト**: 設定ファイルにecs.scheduledTasks.cpuとmemoryを設定し、デプロイし、CloudWatch LogsでEventBridgeスケジュールタスクがそのリソース割り当てで実行されることを確認することで、完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** 設定ファイルでecs.scheduledTasks.cpuが1024、ecs.scheduledTasks.memoryが3072に設定されている、**操作** スケジュールタスクが実行される、**期待結果** タスクがCPU 1024、メモリ3072で実行される
2. **前提条件** スケジュールタスクのCPU/メモリ設定が指定されていない、**操作** スケジュールタスクが実行される、**期待結果** タスクがメインアプリタスク定義のリソース設定をデフォルトとして使用する

---

### エッジケース

- 無効なCPU/メモリの組み合わせが指定された場合はどうなるか（例: AWS Fargateの制限によりメモリがCPUと互換性がない）？
- アプリケーションの起動を妨げるほど低いリソース割り当てが設定された場合はどうなるか？
- ECSサービスの更新が必要な設定変更をシステムはどう処理するか（ローリングデプロイの動作）？
- CPUのみが指定されメモリが省略された場合、またはその逆の場合はどうなるか？

## 要件 _(必須)_

### 機能要件

- **FR-001**: 設定ファイルは、`ecs.mainApp`セクション配下の`cpu`と`memory`フィールドで、メインDecidimアプリケーションタスクのオプショナルなCPUとメモリ仕様をサポートしなければならない
- **FR-002**: 設定ファイルは、`ecs.sidekiq`セクション配下の`cpu`と`memory`フィールドで、SidekiqワーカータスクのオプショナルなCPUとメモリ仕様をサポートしなければならない
- **FR-003**: 設定ファイルは、`ecs.scheduledTasks`セクション配下の`cpu`と`memory`フィールドで、スケジュールされたメンテナンスタスクのオプショナルなCPUとメモリ仕様をサポートしなければならない
- **FR-004**: システムは、メインアプリのECSタスク定義を作成する際に、設定ファイルで指定されたCPUとメモリ値を使用しなければならない
- **FR-005**: システムは、SidekiqワーカーのECSタスク定義を作成する際に、設定ファイルで指定されたCPUとメモリ値を使用しなければならない
- **FR-006**: システムは、スケジュールタスクのタスク定義を作成する際に、設定ファイルで指定されたCPUとメモリ値を使用しなければならない
- **FR-007**: システムは、設定値が指定されていない場合、現在のハードコードされたデフォルト値（メインアプリ: CPU 2048/メモリ4096、Sidekiq: CPU 512/メモリ2048）を使用することで後方互換性を維持しなければならない
- **FR-008**: CPU値は、AWS Fargateの規約に従ってCPUユニット（1024ユニット = 1 vCPU）で指定されなければならない
- **FR-009**: メモリ値は、AWS Fargateの規約に従ってMiB（メビバイト）で指定されなければならない
- **FR-010**: 設定インターフェースは、RDSやElastiCache設定で使用されている既存の設定ファイルJSON構造パターンと一致しなければならない
- **FR-011**: 各環境の設定ファイル（dev.json、staging.json、prd-v0292.json、dev2.json）は、それぞれ独立して異なるリソース値を指定できなければならない

### 主要エンティティ

- **ECSタスク設定**: 特定のECSタスクタイプ（メインアプリ、sidekiq、スケジュールタスク）のCPUとメモリリソース割り当てを表す。cpu（CPUユニット数）とmemory（MiB数）の属性を含む。
- **環境設定**: 1つのデプロイ環境（dev、staging、production）の完全な設定を表す。ECSタスク設定と、既存のRDS、ElastiCache、その他のインフラ設定を含む。

## 成功基準 _(必須)_

### 測定可能な成果

- **SC-001**: インフラ運用者は、より低いCPU/メモリ値を設定することで、本番環境よりも50%少ないリソースで開発環境をデプロイでき、AWSコストを比例的に削減できる
- **SC-002**: 本番環境をCPU 4096ユニット、メモリ8192 MiBにスケールアップし、開発環境をCPU 1024ユニット、メモリ2048 MiBで同時に実行できる（コード変更なし）
- **SC-003**: ECSリソースへの設定変更は、TypeScriptコードを変更せずにデプロイできる（JSON設定ファイルの変更のみで可能）
- **SC-004**: 新しい設定が追加されない場合、すべての既存環境（dev、staging、prd-v0292、dev2）が現在のリソースレベルで引き続き正常にデプロイされる（後方互換性が維持される）
- **SC-005**: スケジュールされたメンテナンスタスクに独立したリソースを割り当てられ、本番環境タスクは大規模データセットを処理でき（例: CPU 2048/メモリ4096）、開発環境タスクは最小限のリソースを使用できる（CPU 512/メモリ1024）

## 前提条件

- 既存のAWS Fargate CPUとメモリの組み合わせルールは、AWS CDKの合成時に検証されるため、設定システムは有効な組み合わせの検証ロジックを実装する必要がない
- インフラ運用者はAWS FargateのCPUとメモリ仕様に精通しており、有効な組み合わせを理解している（例: CPU 512は1024-4096 MBのメモリを持てる、CPU 1024は2048-8192 MBなど）
- すべての環境は最終的に新しい設定フォーマットを採用するが、移行期間中は設定駆動とデフォルト値の両方が共存する必要がある
- スケジュールタスクは現在メインタスク定義を共有しているため、独立して設定可能にするには、スケジュール実行用の別のタスク定義を作成する必要がある可能性がある
- 設定変更は実行中のタスクにすぐには影響しない。効果を発揮するには新しいデプロイが必要
- オートスケーリングのターゲット（CPU 50%、メモリ70%）は環境間で一定であり、現時点では環境ごとの設定は不要

## 依存関係

- 既存の設定読み込みシステム（lib/config.tsとgetConfig関数）
- 既存のECSタスク定義作成処理（lib/decidim-stack.ts）
- 既存の設定ファイル構造とJSONスキーマパターン
- CPUとメモリパラメータを受け入れるAWS CDK ECSコンストラクト

## スコープ外

- 環境ごとのオートスケーリング閾値設定（ハードコードされたCPU 50%、メモリ70%のターゲットを引き続き使用）
- 環境ごとのヘルスチェック設定
- コンテナレベルのリソース予約（ソフトリミット） - タスクレベルの設定のみ
- デプロイなしでのランタイムリソース調整
- 適切なリソースサイジングのためのコスト見積もりや推奨ツール
- アプリケーション機能に対して低すぎる可能性があるリソース設定の検証や警告
- タスク定義内でappコンテナとは別にnginxコンテナリソースを設定すること
