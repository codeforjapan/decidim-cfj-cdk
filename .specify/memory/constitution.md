<!--
同期影響レポート
==================
バージョン: 1.0.0 → 1.1.0 (ドキュメント言語原則の追加)
承認日: 2026-01-18
最終改定日: 2026-01-18

変更内容:
- 追加: VI. ドキュメント言語統一 - すべてのドキュメントと資料を日本語で記述する原則を追加
- 変更: コード品質基準のドキュメンテーションセクションに日本語使用の要件を追加
- 明確化: コミットメッセージは日本語を推奨（SHOULD）レベルに設定

バージョンアップ理由: 新しい原則の追加（MINOR）

テンプレート状況:
- ✅ plan-template.md: ドキュメント言語要件と整合
- ✅ spec-template.md: 日本語ドキュメント要件と互換性あり
- ✅ tasks-template.md: 日本語ドキュメント作成タスクをサポート
- ✅ すべてのコマンドファイル: 日本語出力要件と整合

フォローアップTODO: なし
-->

# Decidim CFJ CDK 憲法

## コア原則

### I. Infrastructure-as-Code標準

インフラストラクチャは、AWS CDK with TypeScriptを使用して宣言的に定義されなければならない（MUST）。すべてのAWSリソースは、明示的な依存関係を持つCDKスタックを通じてプロビジョニングされなければならない（MUST）。本番環境およびステージング環境での手動コンソール変更は禁止される。

**根拠**: 宣言的インフラストラクチャは再現性を保証し、バージョン管理を可能にし、構成のドリフトを防ぐ。明示的な依存関係は、正しいスタックデプロイ順序を保証する。

### II. マルチステージアーキテクチャ

インフラストラクチャは、ステージ固有の設定を持つ複数の分離されたステージ（dev、staging、prd-v0292、dev2）をサポートしなければならない（MUST）。各ステージは、他のステージに影響を与えることなく独立してデプロイ可能でなければならない（MUST）。すべてのCDK操作にはステージコンテキストが必須である（MUST）。

**根拠**: ステージの分離は、本番環境への誤った変更を防ぎ、安全なテストを可能にし、並行開発ワークフローをサポートする。

### III. セキュリティとアクセス制御

セキュリティグループは、明示的なingress/egressルールを持つ最小権限の原則に従わなければならない（MUST）。シークレットは、コードや設定ファイルには決して含めず、AWS Systems Manager Parameter Storeに保存しなければならない（MUST）。すべての本番リソースは、暗号化された接続（HTTPS、暗号化されたRDSストレージ、暗号化されたRedis）を使用しなければならない（MUST）。

**根拠**: 多層防御セキュリティは、不正アクセスとデータ侵害を防ぐ。集中化されたシークレット管理は、露出リスクを軽減する。

### IV. 設定管理

すべてのスタック設定は、`config/`配下のJSONファイルに外部化されなければならない（MUST）。設定の読み込みは、`lib/config.ts`モジュールを通じて型安全でなければならない（MUST）。環境固有の値（データベース認証情報、APIキー）は、実行時にSSM Parameter Storeから注入されなければならない（MUST）。

**根拠**: 設定をコードから分離することで、コード変更なしに環境固有のデプロイが可能になる。型安全性は、実行時の設定エラーを防ぐ。

### V. テストと検証

インフラストラクチャの変更には、CloudFormationテンプレート構造を検証するJestスナップショットテストを含めなければならない（MUST）。デプロイ前の検証には、変更をレビューするために`cdk diff`を使用しなければならない（MUST）。コード品質は、コミット前に`npm run check`が合格するESLintとPrettierを通じて強制されなければならない（MUST）。

**根拠**: インフラストラクチャコードのテストは、デプロイの失敗とリソースの誤設定を防ぐ。差分レビューは、デプロイ前に意図しない変更を検出する。

### VI. ドキュメント言語統一

すべてのプロジェクトドキュメント、設計資料、仕様書、タスクリストは日本語で記述されなければならない（MUST）。コミットメッセージおよびコード内のコメントも日本語で記述することを推奨する（SHOULD）。ただし、変数名、関数名、型名などのコード識別子は英語を使用する。

**根拠**: 言語を統一することでチーム内のコミュニケーションが円滑になり、ドキュメントの一貫性が保たれる。日本語を使用することで、プロジェクトメンバー全員が正確に理解し、効率的に作業できる。

## デプロイと運用

### ステージ管理

- すべてのCDKコマンドには`--context stage=<stage>`パラメータを含めなければならない（MUST）
- 有効なステージ: `dev`、`staging`、`prd-v0292`、`dev2`
- デプロイコマンドには、Decidim Dockerイメージバージョンを指定するために`--context tag=<image-tag>`を含めなければならない（MUST）
- 本番デプロイの前には、ステージングでの検証が成功していなければならない（MUST）
- リソース命名は、パターン`${stage}${serviceName}<ResourceType>`に従わなければならない（MUST）

### デプロイ前提条件

任意のステージをデプロイする前に、以下の条件を検証しなければならない（MUST）：

1. 適切なプロファイル（通常は`decidim`）でAWS認証情報が設定されている
2. タグ付けされたDecidim Dockerイメージを持つECRリポジトリが存在する
3. ターゲットドメイン用のRoute53ホストゾーンが存在する
4. ACM証明書がプロビジョニング済み（ALB用にap-northeast-1、CloudFront用にus-east-1）
5. ステージに必要なシークレットでSSM Parameter Storeが設定済み
6. Dockerイメージがデプロイタグとともにビルドされ、ECRにプッシュ済み

### 運用安全性

- 本番変更は、段階的なロールアウトに従わなければならない（MUST）: dev → staging → production
- データベースマイグレーションは、本番デプロイ前に非本番ステージでテストされなければならない（MUST）
- ロールバック手順は、重要なコンポーネント（RDS、ECSサービス）について文書化され、テストされなければならない（MUST）
- ECSタスクのスケーリングポリシーは、実際の負荷パターンに基づいて監視され、調整されなければならない（MUST）

## コード品質基準

### コードスタイル

- TypeScript strictモードを有効化しなければならない（MUST）
- ES2018以降をターゲットとする
- すべてのコードはESLintチェックに合格しなければならない（MUST）（`npm run lint`）
- すべてのコードはPrettierでフォーマットされなければならない（MUST）（`npm run format`）
- プレコミットチェックは`npm run check`（フォーマットチェック + lint）を実行しなければならない（MUST）

### ドキュメンテーション

- すべてのドキュメント（README、設計書、仕様書、手順書など）は日本語で記述しなければならない（MUST）
- CLAUDE.mdは、アーキテクチャの変更と運用手順について最新の状態を保たなければならない（MUST）
- 設定変更は、gitコミットメッセージに根拠とともに文書化することを推奨する（SHOULD）。日本語での記述を推奨する
- スタック構造への破壊的変更は、すべてのチームメンバーに日本語で伝達されなければならない（MUST）
- 新しいステージには、設定JSONファイルにセットアップドキュメントを日本語で含めなければならない（MUST）
- コード内のコメントは日本語で記述することを推奨する（SHOULD）

### テスト

- すべてのスタックには、`test/`ディレクトリにJestテストが必要である（MUST）
- テストは、CloudFormationテンプレートのスナップショットテストを使用しなければならない（MUST）
- テストは、重要なリソースプロパティ（セキュリティグループ、IAMポリシー、環境変数）を検証しなければならない（MUST）
- テストの失敗は、デプロイをブロックしなければならない（MUST）

## ガバナンス

### 改定手順

1. この憲法への変更提案は、根拠とともに日本語で文書化されなければならない（MUST）
2. セキュリティまたはデプロイ実践に影響する変更は、インフラストラクチャチームリードによってレビューされなければならない（MUST）
3. バージョン番号は、セマンティックバージョニングを使用して増加されなければならない（MUST）：
   - MAJOR: 後方互換性のない変更（例：ステージサポートの削除、スタック構造の変更）
   - MINOR: 新しい原則またはステージの追加（例：新しいデプロイステージの追加）
   - PATCH: 明確化、表現の改善、誤字修正
4. 改定の承認には、アクティブなプロジェクト貢献者のコンセンサスが必要である
5. 既存のデプロイに影響する変更には、移行計画を提供しなければならない（MUST）

### コンプライアンスレビュー

- すべてのプルリクエストは、コア原則へのコンプライアンスを検証しなければならない（MUST）
- 複雑性を導入するインフラストラクチャ変更（新しいスタック、新しいAWSサービス）は、よりシンプルな代替案に対して正当化されなければならない（MUST）
- セキュリティ原則の違反は、明示的に文書化され、承認されなければならない（MUST）
- 設定変更は、外部化原則に従わなければならない（MUST）（ハードコードされた環境固有の値なし）
- ドキュメント言語原則の違反（英語でのドキュメント作成）は、正当な理由がない限り認められない

### ランタイム開発ガイダンス

日常の開発ワークフローとコマンドリファレンスについては、CLAUDE.mdを参照すること。この憲法は、交渉不可能な原則を確立する。CLAUDE.mdは、実用的な実装ガイダンスを提供する。

**バージョン**: 1.1.0 | **承認日**: 2026-01-18 | **最終改定日**: 2026-01-18
